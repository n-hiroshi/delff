<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>delff.lammpsff &mdash; delff  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            delff
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../delff.html">delff package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">delff</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">delff.lammpsff</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for delff.lammpsff</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="nn">delff.objects</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="read_system"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.read_system">[docs]</a><span class="k">def</span> <span class="nf">read_system</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="n">data_file</span><span class="p">,</span><span class="n">atomtypesets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads system data from the settings and data files in the LAMMPS format. </span>

<span class="sd">    Arguments:</span>
<span class="sd">        in_settings_file (str): Path to the settings file.</span>
<span class="sd">        data_file (str): Path to the data file.</span>
<span class="sd">        atomtypesets (list, optional): List of atom type sets. If None, it will be created in the function. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - ff_ (ForceField): Updated ForceField object.</span>
<span class="sd">            - sys_ (System): System object containing the molecular system data.</span>
<span class="sd">            - ffa_ (ForceFieldAssignments): Updated ForceFieldAssignments object.</span>
<span class="sd">            - atomtypelabels (list): List of atom type labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nmolvec</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">eachset</span> <span class="ow">in</span> <span class="n">atomtypesets</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">eachset</span> <span class="p">])</span>
    <span class="n">natomvec</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">natom</span><span class="p">])</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">dihedralmasks</span><span class="p">,</span><span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">read_system_in_settings</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="n">charges</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># atomtypelabels is a str-list which is NOT compatible with JAX.</span>
    <span class="n">ffa_</span><span class="p">,</span> <span class="n">sys_</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">atomtypelabels</span> <span class="o">=</span> <span class="n">read_system_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">dihedralmasks</span><span class="p">,</span><span class="n">dihedralphis</span><span class="p">,</span><span class="n">nmolvec</span><span class="p">,</span><span class="n">natomvec</span><span class="p">)</span>
    <span class="n">ff_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">read_system_in_settings</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="n">charges</span><span class="o">=</span><span class="n">charges</span><span class="p">)</span>


    <span class="c1"># create atomtypesets if necessary</span>
    <span class="k">if</span> <span class="n">atomtypesets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">natomtypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">atomtypesets</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natomtypes</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">iatom</span><span class="p">,</span><span class="n">itype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">):</span>
            <span class="n">atomtypesets</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iatom</span><span class="p">)</span>

    <span class="c1"># charge and pairs averaging based on atomtypesets</span>
    <span class="n">natommol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">)</span>
    <span class="n">pairsnb</span>   <span class="o">=</span> <span class="n">make_nbpairs</span><span class="p">(</span><span class="n">ff_</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">chargesnb</span> <span class="o">=</span> <span class="n">make_nbcharges</span><span class="p">(</span><span class="n">ff_</span><span class="o">.</span><span class="n">charges</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">massesnb</span>  <span class="o">=</span> <span class="n">make_nbmasses</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">masses</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">ff_</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">ff_</span><span class="p">,</span><span class="n">charges</span><span class="o">=</span><span class="n">chargesnb</span><span class="p">)</span>
    <span class="n">ff_</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">ff_</span><span class="p">,</span><span class="n">pairs</span><span class="o">=</span><span class="n">pairsnb</span><span class="p">)</span>
    <span class="n">ffa_</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">ffa_</span><span class="p">,</span><span class="n">masses</span><span class="o">=</span><span class="n">massesnb</span><span class="p">)</span>

    <span class="n">atomtypelabels</span> <span class="o">=</span> <span class="n">make_atomtypelabels</span><span class="p">(</span><span class="n">atomtypelabels</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">)</span>

    <span class="c1"># update atomtypes and labels</span>
    <span class="n">atomtypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">natommol</span><span class="p">,</span><span class="n">i32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">itype</span><span class="p">,</span> <span class="n">atomset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="n">atomset</span><span class="p">:</span>
            <span class="n">atomtypes</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">itype</span><span class="p">)</span>
    <span class="n">ffa_</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">ffa_</span><span class="p">,</span><span class="n">atomtypes</span><span class="o">=</span><span class="n">atomtypes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ff_</span><span class="p">,</span> <span class="n">sys_</span><span class="p">,</span> <span class="n">ffa_</span><span class="p">,</span> <span class="n">atomtypelabels</span></div>


<div class="viewcode-block" id="read_system_in_settings"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.read_system_in_settings">[docs]</a><span class="k">def</span> <span class="nf">read_system_in_settings</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="n">charges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a system settings file in the LAMMPS format.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        in_settings_file (str): Path to the settings file.</span>
<span class="sd">        charges (jax.numpy.ndarray, optional): Array containing charges. If None, no charges will be assigned. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - ff_ (ForceField): ForceField object containing the force field parameters.</span>
<span class="sd">            - dihedralmasks (jax.numpy.ndarray): Array of dihedral masks.</span>
<span class="sd">            - dihedralphis (jax.numpy.ndarray): Array of dihedral angles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nbondtypes</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nangletypes</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ndihedraltypes</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">npairtypes</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">nimpropertypes</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bond_coeff&#39;</span><span class="p">:</span> <span class="n">nbondtypes</span><span class="o">+=</span><span class="mi">1</span>
          <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;angle_coeff&#39;</span><span class="p">:</span> <span class="n">nangletypes</span><span class="o">+=</span><span class="mi">1</span>
          <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dihedral_coeff&#39;</span><span class="p">:</span> <span class="n">ndihedraltypes</span><span class="o">+=</span><span class="mi">1</span>
          <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;improper_coeff&#39;</span><span class="p">:</span> <span class="n">nimpropertypes</span><span class="o">+=</span><span class="mi">1</span>
          <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pair_coeff&#39;</span><span class="p">:</span> <span class="n">npairtypes</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">bondtypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbondtypes</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">angletypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nangletypes</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">dihedralks</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndihedraltypes</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndihedraltypes</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">dihedralmasks</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ndihedraltypes</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span> <span class="c1"># utilize all 4 dihedral factors</span>
    <span class="n">impropertypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nimpropertypes</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npairtypes</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bond_coeff&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">k</span>   <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">bondtypes</span> <span class="o">=</span> <span class="n">bondtypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">bondtypes</span> <span class="o">=</span> <span class="n">bondtypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;angle_coeff&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">k</span>   <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">thetaeq</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">angletypes</span> <span class="o">=</span> <span class="n">angletypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">angletypes</span> <span class="o">=</span> <span class="n">angletypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">thetaeq</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dihedral_coeff&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">v1</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">v2</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">v3</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">v4</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">phieq1</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">phieq2</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">phieq3</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">phieq4</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">phieq1</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">phieq2</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">v3</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">phieq3</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">v4</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">phieq4</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;N in dihedral &gt; 5 is not compatible.&#39;</span><span class="p">)</span>
            <span class="n">dihedralks</span> <span class="o">=</span> <span class="n">dihedralks</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
            <span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">dihedralphis</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">phieq1</span><span class="p">)</span>
            <span class="n">dihedralks</span> <span class="o">=</span> <span class="n">dihedralks</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
            <span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">dihedralphis</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">phieq2</span><span class="p">)</span>
            <span class="n">dihedralks</span> <span class="o">=</span> <span class="n">dihedralks</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>
            <span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">dihedralphis</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">phieq3</span><span class="p">)</span>
            <span class="n">dihedralks</span> <span class="o">=</span> <span class="n">dihedralks</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span>
            <span class="n">dihedralphis</span> <span class="o">=</span> <span class="n">dihedralphis</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">phieq4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pair_coeff&#39;</span><span class="p">:</span> <span class="c1"># pair = Lenard Jones potential</span>
            <span class="n">atomtype0</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">atomtype1</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">assert</span> <span class="n">atomtype0</span> <span class="o">==</span> <span class="n">atomtype1</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">atomtype0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">atomtype0</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;improper_coeff&#39;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># convert k,d, and n in lammps to mag, po, and period in gaussian</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">k</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">po</span> <span class="o">=</span> <span class="mf">180.0</span>
            <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">po</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">period</span> <span class="o">=</span> <span class="n">n</span>
            <span class="n">impropertypes</span> <span class="o">=</span> <span class="n">impropertypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
            <span class="n">impropertypes</span> <span class="o">=</span> <span class="n">impropertypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">po</span><span class="p">)</span>
            <span class="n">impropertypes</span> <span class="o">=</span> <span class="n">impropertypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>


    <span class="c1">#print(&#39;\n# dihedralphis in lammpsff.py: &#39;,dihedralphis)</span>
    <span class="c1">#print(&#39;\n# dihedralks in lammpsff.py: &#39;,dihedralks)</span>
    <span class="n">ff_</span>  <span class="o">=</span> <span class="n">ForceField</span><span class="p">(</span><span class="n">bondtypes</span><span class="p">,</span><span class="n">angletypes</span><span class="p">,</span><span class="n">dihedralks</span><span class="p">,</span><span class="n">impropertypes</span><span class="p">,</span><span class="n">pairs</span><span class="p">,</span><span class="n">charges</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ff_</span><span class="p">,</span><span class="n">dihedralmasks</span><span class="p">,</span><span class="n">dihedralphis</span></div>

<div class="viewcode-block" id="make_nbpairs"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.make_nbpairs">[docs]</a><span class="k">def</span> <span class="nf">make_nbpairs</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates non-bonded pairs based on atom type sets.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        pairs (jax.numpy.ndarray): Array of pair coefficients.</span>
<span class="sd">        atomtypes (jax.numpy.ndarray): Array of atom types.</span>
<span class="sd">        atomtypesets (list): List of atom type sets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        jax.numpy.ndarray: Array of non-bonded pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nnbat</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">pairsnb</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnbat</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">inbat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nnbat</span><span class="p">):</span>
        <span class="n">atomset</span> <span class="o">=</span> <span class="n">atomtypesets</span><span class="p">[</span><span class="n">inbat</span><span class="p">]</span>
        <span class="n">pair0</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">atomtypes</span><span class="p">[</span><span class="n">atomset</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pair1</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">atomtypes</span><span class="p">[</span><span class="n">atomset</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pairsnb</span> <span class="o">=</span> <span class="n">pairsnb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">inbat</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pair0</span><span class="p">)</span>
        <span class="n">pairsnb</span> <span class="o">=</span> <span class="n">pairsnb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">inbat</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pair1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pairsnb</span></div>

<div class="viewcode-block" id="make_nbmasses"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.make_nbmasses">[docs]</a><span class="k">def</span> <span class="nf">make_nbmasses</span><span class="p">(</span><span class="n">masses</span><span class="p">,</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates masses based on atom type sets. </span>

<span class="sd">    Arguments:</span>
<span class="sd">        masses (jax.numpy.ndarray): Array of atom masses.</span>
<span class="sd">        atomtypes (jax.numpy.ndarray): Array of atom types.</span>
<span class="sd">        atomtypesets (list): List of atom type sets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        jax.numpy.ndarray: Array of non-bonded masses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nnbat</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">massesnb</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnbat</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">inbat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nnbat</span><span class="p">):</span>
        <span class="n">atomset</span> <span class="o">=</span> <span class="n">atomtypesets</span><span class="p">[</span><span class="n">inbat</span><span class="p">]</span>
        <span class="n">massenb_</span> <span class="o">=</span> <span class="n">masses</span><span class="p">[</span><span class="n">atomtypes</span><span class="p">[</span><span class="n">atomset</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="n">massesnb</span> <span class="o">=</span> <span class="n">massesnb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">inbat</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">massenb_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">massesnb</span></div>

    
<div class="viewcode-block" id="make_nbcharges"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.make_nbcharges">[docs]</a><span class="k">def</span> <span class="nf">make_nbcharges</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates charges based on atom type sets. </span>

<span class="sd">    Arguments:</span>
<span class="sd">        charges (jax.numpy.ndarray): Array of charges.</span>
<span class="sd">        atomtypes (jax.numpy.ndarray): Array of atom types.</span>
<span class="sd">        atomtypesets (list): List of atom type sets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        jax.numpy.ndarray: Array of non-bonded charges.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nnbat</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="n">chargesnb</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnbat</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">inbat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nnbat</span><span class="p">):</span>
        <span class="n">atomset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">[</span><span class="n">inbat</span><span class="p">])</span>
        <span class="n">chargeset</span> <span class="o">=</span> <span class="n">charges</span><span class="p">[</span><span class="n">atomset</span><span class="p">]</span>
        <span class="n">avecharge</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chargeset</span><span class="p">)</span>
        <span class="n">chargesnb</span> <span class="o">=</span> <span class="n">chargesnb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">inbat</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">avecharge</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chargesnb</span></div>
    
<div class="viewcode-block" id="make_atomtypelabels"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.make_atomtypelabels">[docs]</a><span class="k">def</span> <span class="nf">make_atomtypelabels</span><span class="p">(</span><span class="n">atomtypelabels</span><span class="p">,</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">atomtypesets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates atom type labels based on atom type sets. </span>

<span class="sd">    Arguments:</span>
<span class="sd">        atomtypelabels (list): List of initial atom type labels.</span>
<span class="sd">        atomtypes (jax.numpy.ndarray): Array of atom types.</span>
<span class="sd">        atomtypesets (list): List of atom type sets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: Updated list of atom type labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atomtypelabels_</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">nnbat</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypesets</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">inbat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nnbat</span><span class="p">):</span>
        <span class="n">isUpdate</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">atomset</span> <span class="o">=</span> <span class="n">atomtypesets</span><span class="p">[</span><span class="n">inbat</span><span class="p">]</span>
        <span class="n">atomtype</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="p">[</span><span class="n">atomset</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">atomtypelabel</span> <span class="o">=</span> <span class="n">atomtypelabels</span><span class="p">[</span><span class="n">atomtype</span><span class="p">]</span>
        <span class="c1">#print(atomtype,atomtypelabel)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">isUpdate</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">cand_atomtypelabel</span> <span class="o">=</span> <span class="n">atomtypelabel</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span>
            <span class="k">if</span> <span class="n">cand_atomtypelabel</span> <span class="ow">in</span> <span class="n">atomtypelabels_</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atomtypelabels_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cand_atomtypelabel</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">99</span>

    <span class="n">atomtypelabels__</span> <span class="o">=</span> <span class="n">atomtypelabels_</span>
    <span class="k">for</span> <span class="n">ilabel0</span><span class="p">,</span> <span class="n">atomtypelabel0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomtypelabels_</span><span class="p">):</span>
        <span class="n">flag_dupl</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ilabel1</span><span class="p">,</span> <span class="n">atomtypelabel1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomtypelabels_</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ilabel0</span> <span class="o">!=</span> <span class="n">ilabel1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atomtypelabel0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">atomtypelabel1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">flag_dupl</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">#print(flag_dupl)</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">flag_dupl</span><span class="p">):</span>
            <span class="n">atomtypelabels__</span><span class="p">[</span><span class="n">ilabel0</span><span class="p">]</span><span class="o">=</span><span class="n">atomtypelabel0</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">atomtypelabels__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">atomtypelabels__</span></div>



<div class="viewcode-block" id="read_system_data"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.read_system_data">[docs]</a><span class="k">def</span> <span class="nf">read_system_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">dihedralmasks</span><span class="p">,</span><span class="n">dihedralphis</span><span class="p">,</span><span class="n">nmolvec</span><span class="p">,</span><span class="n">natomvec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads system data from the given file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data_file (str): Path to the data file.</span>
<span class="sd">        dihedralmasks (jax.numpy.ndarray): Array of dihedral masks.</span>
<span class="sd">        dihedralphis (jax.numpy.ndarray): Array of dihedral angles.</span>
<span class="sd">        nmolvec (jax due to similar content.</span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing ff_ (ForceField), sys_ (System), ffa_ (ForceFieldAssignments), and atomtypelabels (List of str). These objects contain the information for the system, the force field, the force field assignments for each atom, and the atom type labels, respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nbonds</span><span class="p">,</span><span class="n">nangles</span><span class="p">,</span><span class="n">ndihedrals</span><span class="p">,</span><span class="n">nimpropers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">lBonds</span><span class="p">,</span><span class="n">lAngles</span><span class="p">,</span><span class="n">lDihedrals</span><span class="p">,</span><span class="n">lImpropers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">iline</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
          <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Masses&#39;</span><span class="p">:</span> <span class="n">lMasses</span> <span class="o">=</span> <span class="n">iline</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Atoms&#39;</span><span class="p">:</span> <span class="n">lAtoms</span> <span class="o">=</span> <span class="n">iline</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Bonds&#39;</span><span class="p">:</span> <span class="n">lBonds</span> <span class="o">=</span> <span class="n">iline</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Angles&#39;</span><span class="p">:</span> <span class="n">lAngles</span> <span class="o">=</span> <span class="n">iline</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Dihedrals&#39;</span><span class="p">:</span> <span class="n">lDihedrals</span> <span class="o">=</span> <span class="n">iline</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Impropers&#39;</span><span class="p">:</span> <span class="n">lImpropers</span> <span class="o">=</span> <span class="n">iline</span>
          <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;atoms&#39;</span><span class="p">:</span> <span class="n">natoms</span><span class="o">=</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;bonds&#39;</span><span class="p">:</span> <span class="n">nbonds</span><span class="o">=</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;angles&#39;</span><span class="p">:</span> <span class="n">nangles</span><span class="o">=</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;dihedrals&#39;</span><span class="p">:</span> <span class="n">ndihedrals</span><span class="o">=</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
              <span class="k">elif</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;impropers&#39;</span><span class="p">:</span> <span class="n">nimpropers</span><span class="o">=</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;atom&#39;</span> <span class="ow">and</span> <span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;types&#39;</span><span class="p">:</span> <span class="n">natomtypes</span> <span class="o">=</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">4</span><span class="p">:</span>
              <span class="k">if</span> <span class="s1">&#39;xy&#39;</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The lattice must be an orthorhombic or cubic cell.&#39;</span><span class="p">)</span>
             
    <span class="n">atomtypes</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">masses</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natomtypes</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">atomtypelabels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">charges</span>   <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="c1">#charges_eachatom = jnp.zeros((natoms),f64)</span>
    <span class="c1">#charges   = jnp.zeros((natomtypes),f64)</span>
    <span class="n">coord_</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">f64</span><span class="p">)</span>
    <span class="n">bonds</span>     <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nbonds</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">angles</span>    <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nangles</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">dihedrals</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndihedrals</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">impropers</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nimpropers</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">i32</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">iline</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
          <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

          <span class="c1"># Masses</span>
          <span class="k">if</span> <span class="n">lMasses</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lMasses</span> <span class="o">+</span> <span class="n">natomtypes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">masses</span><span class="o">=</span><span class="n">masses</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
              <span class="n">atomtypelabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

          <span class="c1"># Atoms</span>
          <span class="k">if</span> <span class="n">lAtoms</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lAtoms</span> <span class="o">+</span> <span class="n">natoms</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Thid system.data file can only include a single molecule.&#39;</span><span class="p">)</span>
              <span class="n">atomtypes</span><span class="o">=</span><span class="n">atomtypes</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="c1">#charges_eachatom=charges_eachatom.at[i32(words[0])-1].set(f64(words[3]))</span>
              <span class="n">charges</span><span class="o">=</span><span class="n">charges</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
              <span class="n">coord_</span><span class="o">=</span><span class="n">coord_</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
              <span class="n">coord_</span><span class="o">=</span><span class="n">coord_</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
              <span class="n">coord_</span><span class="o">=</span><span class="n">coord_</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f64</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
             
          <span class="c1"># Bonds</span>
          <span class="k">if</span> <span class="n">lBonds</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lBonds</span> <span class="o">+</span> <span class="n">nbonds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">bonds</span><span class="o">=</span><span class="n">bonds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">bonds</span><span class="o">=</span><span class="n">bonds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">bonds</span><span class="o">=</span><span class="n">bonds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             
          <span class="c1"># Angles</span>
          <span class="k">if</span> <span class="n">lAngles</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lAngles</span> <span class="o">+</span> <span class="n">nangles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">angles</span><span class="o">=</span><span class="n">angles</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          
          <span class="c1"># Dihedrals</span>
          <span class="k">if</span> <span class="n">lDihedrals</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lDihedrals</span> <span class="o">+</span> <span class="n">ndihedrals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">dihedrals</span><span class="o">=</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

          <span class="c1"># Impropers </span>
          <span class="c1"># convert the tyle in https://docs.lammps.org/improper_cvff.html</span>
          <span class="c1"># to ImpTrs in https://gaussian.com/mm/</span>
          <span class="k">if</span> <span class="n">lImpropers</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="ow">and</span> <span class="n">iline</span> <span class="o">&lt;=</span> <span class="n">lImpropers</span> <span class="o">+</span> <span class="n">nimpropers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
              <span class="n">impropers</span><span class="o">=</span><span class="n">impropers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">impropers</span><span class="o">=</span><span class="n">impropers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">impropers</span><span class="o">=</span><span class="n">impropers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">impropers</span><span class="o">=</span><span class="n">impropers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
              <span class="n">impropers</span><span class="o">=</span><span class="n">impropers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">i32</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#for iatom, charge in enumerate(charges_eachatom):</span>
    <span class="c1">#    charges = charges.at[atomtypes[iatom]].set(charges_eachatom[iatom])</span>

    <span class="c1">#print(&#39;charges&#39;,charges)</span>

    <span class="n">natoms</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">adjmat012</span><span class="p">,</span> <span class="n">adjmat3</span> <span class="o">=</span> <span class="n">generate_scale_mat</span><span class="p">(</span><span class="n">bonds</span><span class="p">,</span><span class="n">natoms</span><span class="p">)</span>

    <span class="n">coord_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">coord_</span><span class="p">,(</span><span class="n">nmolvec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">sys_</span>  <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">coord_</span><span class="p">)</span>
    <span class="n">ffa_</span>  <span class="o">=</span> <span class="n">ForceFieldAssignments</span><span class="p">(</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">masses</span><span class="p">,</span><span class="n">bonds</span><span class="p">,</span><span class="n">angles</span><span class="p">,</span><span class="n">dihedrals</span><span class="p">,</span><span class="n">dihedralmasks</span><span class="p">,</span><span class="n">dihedralphis</span><span class="p">,</span><span class="n">impropers</span><span class="p">,</span><span class="n">adjmat012</span><span class="p">,</span><span class="n">adjmat3</span><span class="p">,</span><span class="n">nmolvec</span><span class="p">,</span><span class="n">natomvec</span><span class="p">)</span>

    <span class="c1">#print(ffa_.atomtypes)</span>
    <span class="c1">#print(atomtypes)</span>
    <span class="k">return</span> <span class="n">ffa_</span><span class="p">,</span> <span class="n">sys_</span><span class="p">,</span> <span class="n">charges</span><span class="p">,</span> <span class="n">atomtypelabels</span></div>

<div class="viewcode-block" id="generate_scale_mat"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.generate_scale_mat">[docs]</a><span class="k">def</span> <span class="nf">generate_scale_mat</span><span class="p">(</span><span class="n">bonds</span><span class="p">,</span> <span class="n">natoms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates matrices that represent scaled bonding connections between atoms in a molecular system.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        bonds (ndarray): Array of bonds where each bond is represented by a pair of atom indices.</span>
<span class="sd">        natoms (int): Total number of atoms in the system.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple of matrices that represent scaled bonding connections. </span>
<span class="sd">               The first matrix contains bonding connections of distance 1 and 2. </span>
<span class="sd">               The second matrix contains bonding connections of distance 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bonds</span> <span class="o">=</span> <span class="n">bonds</span>
    <span class="n">nbonds</span> <span class="o">=</span> <span class="n">bonds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># adjmat01</span>
    <span class="n">adjmat01</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">adjmat012</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">i32</span><span class="p">)</span>
    <span class="n">adjmat3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">natoms</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">i32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ibond</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbonds</span><span class="p">):</span> 
        <span class="n">adjmat01</span><span class="o">=</span><span class="n">adjmat01</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">bonds</span><span class="p">[</span><span class="n">ibond</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">bonds</span><span class="p">[</span><span class="n">ibond</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">adjmat01</span><span class="o">=</span><span class="n">adjmat01</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">bonds</span><span class="p">[</span><span class="n">ibond</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">bonds</span><span class="p">[</span><span class="n">ibond</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
        <span class="n">dist1vec</span> <span class="o">=</span> <span class="n">adjmat01</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span>
        <span class="n">adjmat012</span><span class="o">=</span><span class="n">adjmat012</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dist1vec</span><span class="p">)</span> <span class="c1"># dist=1</span>
        <span class="k">for</span> <span class="n">jatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist1vec</span><span class="p">[</span><span class="n">jatom</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># connect directly</span>
                <span class="n">adjmat012</span> <span class="o">=</span> <span class="n">adjmat012</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">adjmat012</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">+</span><span class="n">adjmat01</span><span class="p">[</span><span class="n">jatom</span><span class="p">,:])</span> <span class="c1"># dist=2</span>
    
    <span class="n">adjmat012</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">i32</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)(</span><span class="n">adjmat012</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
        <span class="n">dist2vec</span> <span class="o">=</span> <span class="n">adjmat012</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span>
        <span class="n">adjmat3</span><span class="o">=</span><span class="n">adjmat3</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dist2vec</span><span class="p">)</span> <span class="c1"># dist=2</span>
        <span class="k">for</span> <span class="n">jatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist2vec</span><span class="p">[</span><span class="n">jatom</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#  connect within &lt;2 topological distances</span>
                <span class="n">adjmat3</span> <span class="o">=</span> <span class="n">adjmat3</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">adjmat3</span><span class="p">[</span><span class="n">iatom</span><span class="p">,:]</span><span class="o">+</span><span class="n">adjmat01</span><span class="p">[</span><span class="n">jatom</span><span class="p">,:])</span> <span class="c1"># dist=3</span>

    <span class="n">adjmat3</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">i32</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)(</span><span class="n">adjmat3</span><span class="p">)</span>
    <span class="n">adjmat3</span> <span class="o">-=</span> <span class="n">adjmat012</span>

    <span class="k">return</span> <span class="n">adjmat012</span><span class="p">,</span> <span class="n">adjmat3</span></div>
          

          



<div class="viewcode-block" id="write_system_in_settings"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.write_system_in_settings">[docs]</a><span class="k">def</span> <span class="nf">write_system_in_settings</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="n">ff_</span><span class="p">,</span><span class="n">ffa_</span><span class="p">,</span><span class="n">charges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes the system settings, including force field parameters and coefficients, into a LAMMPS in_settings file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        in_settings_file (str): Name of the output settings file.</span>
<span class="sd">        ff_ (ForceField): ForceField object containing the parameters for the force field.</span>
<span class="sd">        ffa_ (ForceFieldAssignments): ForceFieldAssignments object containing the force field assignments for each atom in the system.</span>
<span class="sd">        charges (ndarray, optional): If given, includes charge information. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nbondtypes</span>     <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">bondtypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nangletypes</span>    <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">angletypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndihedraltypes</span> <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">dihedralks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nimpropertypes</span> <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">npairs</span>         <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_settings_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npairs</span><span class="p">):</span>
            <span class="c1">#f.write(&#39;pair_coeff %d %d lj/charmm/coul/long %16.12f %16.12f\n&#39;%(i+1,i+1,ff_.pairs[i,0],ff_.pairs[i,1]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pair_coeff </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> lj/charmm/coul/long </span><span class="si">%16.12f</span><span class="s1"> </span><span class="si">%16.12f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ff_</span><span class="o">.</span><span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbondtypes</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;bond_coeff </span><span class="si">%d</span><span class="s1"> harmonic </span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%9.5f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">bondtypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ff_</span><span class="o">.</span><span class="n">bondtypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nangletypes</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;angle_coeff </span><span class="si">%d</span><span class="s1"> harmonic </span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%9.5f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">angletypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ff_</span><span class="o">.</span><span class="n">angletypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndihedraltypes</span><span class="p">):</span>
            <span class="n">nterms</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedralmasks</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;dihedral_coeff </span><span class="si">%d</span><span class="s1"> fourier </span><span class="si">%d</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nterms</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">dihedralmasks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%9.5f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ff_</span><span class="o">.</span><span class="n">dihedralks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedralphis</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimpropertypes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">179.9</span><span class="p">:</span> <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span> 
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;improper_coeff </span><span class="si">%d</span><span class="s1"> cvff </span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span> \
                    <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">d</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span></div>

<div class="viewcode-block" id="write_system_data"><a class="viewcode-back" href="../../delff.html#delff.lammpsff.write_system_data">[docs]</a><span class="k">def</span> <span class="nf">write_system_data</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">ff_</span><span class="p">,</span><span class="n">sys_</span><span class="p">,</span><span class="n">ffa_</span><span class="p">,</span><span class="n">atomtypelabels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes the system data including atom types, bond types, coordinates, masses and force field assignments into a LAMMPS data file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data_file (str): Name of the output data file.</span>
<span class="sd">        ff_ (ForceField): ForceField object containing the parameters for the force field.</span>
<span class="sd">        sys_ (System): System object containing the information for the system.</span>
<span class="sd">        ffa_ (ForceFieldAssignments): ForceFieldAssignments object containing the force field assignments for each atom in the system.</span>
<span class="sd">        atomtypelabels (List of str): List of atom type labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;LAMMPS Description</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># block1 nbonds, nangles, ...</span>
        <span class="n">nmol</span> <span class="o">=</span> <span class="n">sys_</span><span class="o">.</span><span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">natomvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nbonds</span> <span class="o">=</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nangles</span> <span class="o">=</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ndihedrals</span> <span class="o">=</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nimpropers</span> <span class="o">=</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> atoms</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">natoms</span><span class="o">*</span><span class="n">nmol</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> bonds</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nbonds</span><span class="o">*</span><span class="n">nmol</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> angles</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nangles</span><span class="o">*</span><span class="n">nmol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ndihedrals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> dihedrals</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ndihedrals</span><span class="o">*</span><span class="n">nmol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nimpropers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> impropers</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nimpropers</span><span class="o">*</span><span class="n">nmol</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># block2 nbondtypes, nangletypes,...</span>
        <span class="n">natomtypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypelabels</span><span class="p">)</span>
        <span class="n">nbondtypes</span>     <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">bondtypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nangletypes</span>    <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">angletypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ndihedraltypes</span> <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">dihedralks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nimpropertypes</span> <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">impropertypes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">npairs</span>         <span class="o">=</span> <span class="n">ff_</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> atom types</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">natomtypes</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> bond types</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">nbondtypes</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> angle types</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">nangletypes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ndihedrals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> dihedral types</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ndihedraltypes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nimpropers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> improper types</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">nimpropertypes</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># lattice</span>
        <span class="n">boxsize</span><span class="o">=</span><span class="mi">100</span>
        <span class="n">halfboxsize</span><span class="o">=</span><span class="n">boxsize</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%9.5f</span><span class="s1"> xlo xhi</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="o">-</span><span class="n">halfboxsize</span><span class="p">,</span><span class="n">halfboxsize</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%9.5f</span><span class="s1"> ylo yhi</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="o">-</span><span class="n">halfboxsize</span><span class="p">,</span><span class="n">halfboxsize</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%9.5f</span><span class="s1"> </span><span class="si">%9.5f</span><span class="s1"> zlo zhi</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="o">-</span><span class="n">halfboxsize</span><span class="p">,</span><span class="n">halfboxsize</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># masses</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Masses</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomtypelabels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">masses</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iatomtype</span><span class="p">,</span> <span class="n">atomtypelabel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomtypelabels</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%9.5f</span><span class="s2"> # </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">iatomtype</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">masses</span><span class="p">[</span><span class="n">iatomtype</span><span class="p">],</span><span class="n">atomtypelabel</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># atoms</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Atoms</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#assert sys_.coord.shape[0] == 1 # This fucntion is now limited to a single molecule.</span>
        <span class="k">assert</span> <span class="n">sys_</span><span class="o">.</span><span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_</span><span class="o">.</span><span class="n">charges</span><span class="p">)</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">)</span>
        <span class="c1">#print(sys_.coord)</span>
        <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natom</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%9.5f</span><span class="s2"> </span><span class="si">%9.5f</span><span class="s2"> </span><span class="si">%9.5f</span><span class="s2"> </span><span class="si">%9.5f</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="o">+</span><span class="n">iatom</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">imol</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ff_</span><span class="o">.</span><span class="n">charges</span><span class="p">[</span><span class="n">ffa_</span><span class="o">.</span><span class="n">atomtypes</span><span class="p">[</span><span class="n">iatom</span><span class="p">]],</span>\
                    <span class="n">sys_</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="n">imol</span><span class="p">,</span><span class="n">iatom</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">sys_</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="n">imol</span><span class="p">,</span><span class="n">iatom</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">sys_</span><span class="o">.</span><span class="n">coord</span><span class="p">[</span><span class="n">imol</span><span class="p">,</span><span class="n">iatom</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># bond</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Bonds</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nbonds</span> <span class="o">==</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbonds</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># angle</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Angles</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nangles</span> <span class="o">==</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nangles</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span>\
                    <span class="n">ffa_</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># dihedral</span>
        <span class="k">if</span> <span class="n">ndihedrals</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Dihedrals</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ndihedrals</span> <span class="o">==</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndihedrals</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span>\
                        <span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># improper</span>
        <span class="k">if</span> <span class="n">nimpropers</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Impropers</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nimpropers</span> <span class="o">==</span> <span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">imol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nimpropers</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span>\
                        <span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">,</span><span class="n">ffa_</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">imol</span><span class="o">*</span><span class="n">natom</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Hiroshi Nakano.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>